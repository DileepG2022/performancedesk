{% extends 'base.html' %}
{% load static %}

{% block content %}


<div class="container mt-4">
  <div id="review_message_container" style="display: none;"></div>

  <div id="form_section">
  <h3>Monthly Review Form</h3>
  <form method="post">
    {% csrf_token %}

    <div class="mb-3">
      <label>Trainer Name:</label>
      <input type="text" class="form-control" value="{{ faculty.user.get_full_name }}" readonly>
    </div>

    <div class="mb-3">
      <label>Batch Name:</label>
      <input type="text" class="form-control" value="{{ batch.name }}" readonly>
      <input type="hidden" id="id_batch" value="{{ batch.id }}">
    </div>

    <div class="row">
      <div class="col">
        <label>Start Date:</label>
        <input type="text" class="form-control" value="{{ batch.start_date }}" readonly>
        
      </div>
      <div class="col">
        <label>End Date:</label>
        <input type="text" class="form-control" value="{{ batch.end_date }}" readonly>
        
      </div>
      <div class="col">
        <label>Total Students:</label>
        <input type="text" class="form-control" value="{{ batch.total_students }}" readonly>
        
      </div>
    </div>

    <div class="mt-3">
      {{ form.review_month.label_tag }} {{ form.review_month }}
    </div>

    <h5 class="mt-4">Metrics</h5>
    <table class="table table-bordered">
      <thead>
        <tr><th>Metric</th><th>Value</th></tr>
      </thead>
      <tbody>
        {% for metric in metrics %}
          <tr>
            <td>
              <input type="text" class="form-control" value="{{ metric.metric.metric_name }}" readonly>
              <input type="hidden" class="form-control" name="metric_name" value="{{ metric.metric.metric_name }}" readonly>
              
            </td>
            <td>
              
              <input type="text" class="form-control" name="metric_value" id="metric_value_{{ metric.metric.id }}" value="{{ metric.value }}" {% if metric.readonly %}readonly{% endif %}>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    <h5 class="mt-4">Milestone Activities</h5>
    <table class="table table-bordered">
      <thead>
        <tr>
          <th style="width: 24%;">Activity</th><th style="width: 7%;">Day</th><th style="width: 15%;">Planned Date</th>
          <th style="width: 12%;">Completed Date</th><th style="width: 15%;">Status</th><th style="width: 7%;">Participation</th><th style="width: 20%;">Remarks</th>
        </tr>
      </thead>
      <tbody>
        {% for activity in activities %}
        <tr>
          <input type="hidden" name="activity_id" value="{{ activity.id }}">
          <td><input type="text" class="form-control" value="{{ activity.activity }}" readonly></td>
          <td><input type="text" class="form-control" value="{{ activity.day }}" readonly></td>
          <td><input type="text" class="form-control" value="{{ activity.planned_date }}" readonly></td>

          <td><input type="date" class="form-control" name="completed_date" id="completed_date_{{ activity.id }}"></td>
          <td>
            <select name="status" class="form-control" id="status_{{ activity.id }}">
              <option value="">-- Select --</option>
              <option value="Completed">Completed</option>
              <option value="Pending">Pending</option>
            </select>
          </td>
          <td><input type="text" name="participation" class="form-control" id="participation_{{ activity.id }}"></td>
          <td><input type="text" name="remarks" class="form-control" id="remarks_{{ activity.id }}"></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <button type="submit" class="btn btn-success" id="submit_btn">Submit Review</button>
  </form>
</div>
</div>
<script>
  // alert("hello");
$(document).ready(function() {

  // function autoSelectMonthWhenReady() {
  //   const monthSelect = $('#id_review_month');
  //   if (monthSelect.length > 0 && monthSelect.find('option').length >= 12) {
  //     const today = new Date();
  //     const monthName = today.toLocaleString('default', { month: 'long' });
  //     alert("h")
  //     monthSelect.val(monthName).trigger('change');
  //   } else {
  //     // Try again after a short delay
  //     setTimeout(autoSelectMonthWhenReady, 100);
  //   }
  // }

  // autoSelectMonthWhenReady(); // Call function once DOM is ready

  // Auto-select current month
    // const today = new Date();
    // const monthName = today.toLocaleString('default', { month: 'long' });
    // $('#id_review_month').val(monthName)
    // console.log($('#id_review_month').length);

    // Trigger change event manually to fetch prefill data
    // $("#id_review_month").trigger('change');

    // AJAX on month change
    $('#id_review_month').change(function() {
    //  alert("Hi");
        const reviewMonth = $(this).val();
        const batchId = $('#id_batch').val();  // Add a hidden field if needed
        // alert(reviewMonth)
        // alert(batchId)
        if (reviewMonth && batchId) {
            $.ajax({
                url: '/get-prefill-data/',
                data: {
                    review_month: reviewMonth,
                    batch_id: batchId
                },
                success: function(data) {
                  if (data.message) {
                        alert(data.message);
                    }

                    // Block submission if necessary
    if (data.block_submission) {
        // $('#submit_btn').prop('disabled', true);  // Disable submit button
        // $('#form_section').hide();  // Optional: hide the entire form section
         $('#form_section').hide();
        $('#review_message_container')
            .html(`<div class="alert alert-warning">${data.message}</div>`)
            .show();
        return;
    } else {
        // $('#submit_btn').prop('disabled', false); // Allow submission
        // $('#form_section').show(); // Show form
        $('#form_section').show();
        $('#review_message_container').hide();
    }
                    // Metrics
                    if (data.metrics.length > 0) {
                        data.metrics.forEach((metric) => {
                            const input = $(`#metric_value_${metric.metric_id}`);
                            input.val(metric.value);
                            input.prop('readonly', metric.readonly);
                        });
                    }
                    // Activities
                    if (data.activities.length > 0) {
                        data.activities.forEach((activity) => {
                            $(`#completed_date_${activity.activity_id}`).val(activity.completed_date);
                            $(`#status_${activity.activity_id}`).val(activity.status);
                            $(`#participation_${activity.activity_id}`).val(activity.participation);
                            $(`#remarks_${activity.activity_id}`).val(activity.remarks);
                        });
                    }

                    // $(`#participation_1`).val(testPar)

                    // if (!data.is_prefilled) {
                    //     alert("Prefilled from previous month. Please verify or update.");
                    // }
                }
            });
        }
    });
});
</script>
{% endblock %}


