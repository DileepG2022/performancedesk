{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-5">
    <h2 class="text-center mb-4">Add Monthly Review</h2>
    <!-- Display Messages -->
    {% if messages %}
    <div class="alert-container">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    <div class="card shadow-lg p-4">
        <form id="reviewForm" method="post" action="{% url 'sales_add_monthly_review' %}">
            {% csrf_token %}
            
            <!-- Select Month-Year -->
            <div class="mb-4">
                <label for="review_month" class="form-label">Select Review Month</label>
                <input type="month" id="review_month" name="review_month" class="form-control" required>
            </div>

            <!-- Metrics Table -->
            <div class="table-responsive">
                <table class="table table-bordered table-hover align-middle" id="metricsTable">
                    <thead class="table-dark">
                        <tr>
                            <th style="width:40%">Metric</th>
                            <th style="width:60%">Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- AJAX will populate here -->
                    </tbody>
                </table>
            </div>

            <div class="text-center mt-4">
                <button type="submit" class="btn btn-primary px-5">Save Review</button>
                <a href="{% url 'sales_dashboard' %}" class="btn btn-secondary px-5">Cancel</a>
            </div>
        </form>
    </div>
</div>

<!-- jQuery for AJAX -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function(){

    function slugify(str){
        return (str || '')
            .toLowerCase()
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/(^-|-$)/g, '');
    }

    function loadMetrics() {
        let reviewMonth = $("#review_month").val();
        if (!reviewMonth) return;

        $.ajax({
            url: "{% url 'get_sales_metrics' %}",
            data: {review_month: reviewMonth},
            success: function(response) {
                let tbody = $("#metricsTable tbody");
                tbody.empty();

                response.metrics.forEach(function(metric) {
                    const key = slugify(metric.name);                   // e.g., "total-leads-manual"
                    const inputId = `metric-${key}`;                    // e.g., "metric-total-leads-manual"

                    const dtype = (metric.datatype || '').toLowerCase();
                    const isNumber = dtype === 'number' || dtype === 'decimal';
                    const stepAttr = dtype === 'decimal' ? "step='0.01'" : "";
                    const readonlyAttr = metric.readonly ? "readonly" : "";

                    const row = `
                        <tr data-metric-key="${key}">
                            <td><strong>${metric.name}</strong></td>
                            <td>
                                <input id="${inputId}"
                                       type="${isNumber ? 'number' : 'text'}"
                                       ${stepAttr}
                                       class="form-control metric-input"
                                       data-name="${metric.name}"
                                       name="metric_${metric.id}"
                                       value="${metric.value ?? ''}"
                                       ${readonlyAttr}
                                       required>
                            </td>
                        </tr>`;
                    tbody.append(row);
                });

                // Bind only to Total Leads (delegated event for dynamic inputs)
                $(document)
                  .off('input', '#metric-total-leads')
                  .on('input', '#metric-total-leads', calculateConversion);
            },
            error: function(xhr) {
            let msg = xhr.responseJSON?.error || "An error occurred";
            alert(msg);
            $("#review_month").val("");  // Reset month input
            $("#metricsTable tbody").empty();  // Clear metrics
        }
        });
    }

    function calculateConversion() {
        const leads = parseFloat($('#metric-total-leads').val());
        // alert(leads);
        const admissions = parseFloat($('#metric-total-admissions').val());
        // alert(admissions);
        const $conv = $('#metric-conversion-rate');

        if (!isNaN(leads) && leads > 0 && !isNaN(admissions)) {
            const pct = (admissions / leads) * 100;
            // alert(pct.toFixed(2) + '%');
            $conv.val(pct.toFixed(2));
        } else {
            $conv.val('');
        }
    }

    $("#review_month").on('change', loadMetrics);
});
</script>

{% endblock %}
